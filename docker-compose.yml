services:
  dvwa:
    image: vulnerables/web-dvwa
    platform: linux/amd64
    ports:
      - "8080:80"
    environment:
      - MYSQL_ROOT_PASSWORD=password
    networks:
      - labnet

  mutillidae:
    image: citizenstig/nowasp
    platform: linux/amd64
    ports:
      - "8081:80"
    networks:
      - labnet

  juice-shop:
    image: bkimminich/juice-shop
    ports:
      - "3000:3000"
    networks:
      - labnet

  vuln-server:
    image: arm64v8/ubuntu:22.04
    container_name: vuln-server
    command: >
      bash -c "
        apt update &&
        DEBIAN_FRONTEND=noninteractive apt install -y openssh-server netcat-traditional &&
        mkdir -p /var/run/sshd &&
        echo 'root:toor' | chpasswd &&
        sed -i 's/^#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config &&
        service ssh start &&
        while true; do
          nc -lvnp 4444 -e /bin/bash;
        done
      "
    ports:
      - "2222:22"
      - "4444:4444"
    networks:
      - labnet

  # bWAPP — ещё одна классическая уязвимая PHP-лабка (OWASP bWAPP) [web:86][web:94]
  bwapp:
    image: raesene/bwapp
    platform: linux/amd64
    container_name: bwapp
    ports:
      - "8083:80"
    networks:
      - labnet

  # WebGoat 8 (Java) — тренажёр по уязвимостям в стиле OWASP Top 10 [web:81][web:84][web:88]
  webgoat:
    image: webgoat/webgoat-8.0
    platform: linux/amd64
    container_name: webgoat
    ports:
      - "8082:8080"
    networks:
      - labnet

  # OWASP Security Shepherd — тяжёлый, но мощный тренажёр (можно выключать при необходимости) [web:76][web:87][web:90]
  security-shepherd:
    image: owasp/security-shepherd:latest
    platform: linux/amd64
    container_name: security-shepherd
    ports:
      - "8085:80"
    networks:
      - labnet

  # Kali-основа с основным набором CLI-инструментов (собирается локально под arm64)
  kali:
    build:
      context: .
      dockerfile: Dockerfile.kali
    container_name: kali-attacker
    tty: true
    stdin_open: true
    working_dir: /root
    command: sleep infinity
    volumes:
      - ./loot:/root/loot
    networks:
      labnet:
        ipv4_address: 172.20.0.10

  # Дополнительный лёгкий tools-контейнер (если хочешь не загрязнять основной Kali)
  tools:
    image: kalilinux/kali-rolling
    container_name: pentest-tools
    tty: true
    stdin_open: true
    working_dir: /root
    command: sleep infinity
    networks:
      - labnet
    volumes:
      - ./loot:/root/loot

networks:
  labnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
